Imports Obout.SuperForm
Imports System.Data
Imports System.Data.OleDb
Imports System.Collections.Generic
Imports System.Web.UI.WebControls
Imports Obout.Interface
Imports Obout.ComboBox
Partial Class SuperForm_vb_templates_fileupload
    Inherits System.Web.UI.Page
    Dim fileName As String = ""
    Dim SuperForm1 As Obout.SuperForm.SuperForm

    Sub Page_Load(ByVal sender As Object, ByVal e As EventArgs)
        SuperForm1 = New SuperForm()
        SuperForm1.ID = "SuperForm1"
        SuperForm1.Width = Unit.Pixel(350)
        SuperForm1.DataSourceID = "SqlDataSource1"
        SuperForm1.AutoGenerateRows = False
        SuperForm1.AutoGenerateInsertButton = True
        SuperForm1.AutoGenerateEditButton = True
        SuperForm1.AutoGenerateDeleteButton = True
        SuperForm1.AutoGenerateDateFields = True
        Dim keyNames1() As String = {"ProductID"}
        SuperForm1.DataKeyNames = keyNames1
        SuperForm1.AllowPaging = True
        SuperForm1.DefaultMode = DetailsViewMode.Edit
        SuperForm1.HeaderStyle.Width = Unit.Pixel(150)

        AddHandler SuperForm1.ItemUpdating, AddressOf SuperForm1_ItemUpdating
        AddHandler SuperForm1.ItemInserting, AddressOf SuperForm1_ItemInserting

        Dim field1 As Obout.SuperForm.BoundField = New Obout.SuperForm.BoundField()
        field1.DataField = "ProductID"
        field1.HeaderText = "Product ID"
        field1.ReadOnly = True
        field1.InsertVisible = False

        Dim field2 As Obout.SuperForm.BoundField = New Obout.SuperForm.BoundField()
        field2.DataField = "ProductName"
        field2.HeaderText = "Product Name"
        field2.ItemStyle.Width = 225

        Dim field3 As Obout.SuperForm.BoundField = New Obout.SuperForm.BoundField()
        field3.DataField = "UnitPrice"
        field3.HeaderText = "Unit Price"
        field3.ItemStyle.Width = 225

        Dim field4 As Obout.SuperForm.TemplateField = New Obout.SuperForm.TemplateField()
        field4.HeaderText = "Image"
        field4.ItemTemplate = New ImageItemTemplate()
        field4.EditItemTemplate = New ImageEditItemTemplate()

        SuperForm1.Fields.Add(field1)
        SuperForm1.Fields.Add(field2)
        SuperForm1.Fields.Add(field3)
        SuperForm1.Fields.Add(field4)

        SuperForm1Container.Controls.Add(SuperForm1)

        fileName = ""

        If Page.IsPostBack Then

            Dim files As HttpFileCollection = Page.Request.Files

            If files.Count > 0 Then

                fileName = DateTime.Now.Ticks.ToString() + "_" + files(0).FileName

                files(0).SaveAs(Server.MapPath("~/Grid/resources/images/products/" + fileName))
            End If

        End If
    End Sub
    Public Class ImageItemTemplate
        Implements ITemplate
   
       Sub InstantiateIn(ByVal container As Control) Implements ITemplate.InstantiateIn
            Dim templatePlaceHolder As PlaceHolder = New PlaceHolder()
            container.Controls.Add(templatePlaceHolder)

            Dim img As Image = New Image()
            templatePlaceHolder.Controls.Add(img)

            AddHandler templatePlaceHolder.DataBinding, AddressOf DataBindTemplate
        End Sub

        Sub DataBindTemplate(ByVal sender As Object, ByVal e As EventArgs)

            Dim templatePlaceHolder As PlaceHolder = CType(sender, PlaceHolder)
            Dim row As DetailsViewRow = CType(templatePlaceHolder.Parent.Parent, DetailsViewRow)
            Dim form As SuperForm = CType(row.Parent.Parent, SuperForm)

            Dim img As Image = CType(templatePlaceHolder.Controls(0), Image)

            img.ImageUrl = "~/Grid/resources/images/products/" + DataBinder.Eval(Form.DataItem, "Image").ToString()
            img.AlternateText = ""
            img.Width = 100
        End Sub

    End Class

    Public Class ImageEditItemTemplate
        Implements ITemplate

        Sub InstantiateIn(ByVal container As Control) Implements ITemplate.InstantiateIn
            Dim templatePlaceHolder As PlaceHolder = New PlaceHolder()
            container.Controls.Add(templatePlaceHolder)

            Dim FileUpload As FileUpload = New FileUpload()
            FileUpload.Width = Unit.Pixel(200)
            templatePlaceHolder.Controls.Add(FileUpload)

        End Sub

    End Class

    Sub SuperForm1_ItemUpdating(ByVal sender As Object, ByVal e As DetailsViewUpdateEventArgs)

        e.NewValues("Image") = fileName

    End Sub


    Sub SuperForm1_ItemInserting(ByVal sender As Object, ByVal e As DetailsViewInsertEventArgs)

        e.Values("Image") = fileName
    End Sub

End Class
